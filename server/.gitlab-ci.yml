stages:
  - build
  - deploy

# -------------------------
# BUILD STAGE (MAVEN)
# -------------------------
build:
  stage: build
  image: maven:3.9-eclipse-temurin-21
  script:
    - cd server
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day

# -------------------------
# DEPLOY STAGE
# -------------------------
deploy:
  stage: deploy
  image: alpine:latest

  before_script:
    - apk add --no-cache openssh
    - eval $(ssh-agent -s)

    # Load SSH key from GitLab variable
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -

    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

  variables:
    DEPLOY_SERVERS: ""

  script:
    - |
      TIMESTAMP=$(date +%d%m%Y_%H%M%S)

      # ---------- Populate known_hosts ----------
      for SERVER in "${SERVERS[@]}"; do
        ssh-keyscan -H $SERVER >> ~/.ssh/known_hosts
      done

      # ---------- Deployment ----------
      for SERVER in "${SERVERS[@]}"; do
        echo "Deploying to $SERVER ..."

        ssh nerch@$SERVER "
          set -e

          BACKUP=/opt/nerch/server_${TIMESTAMP}.jar
          CURRENT=/opt/nerch/server.jar

          # Backup current jar if exists
          if [ -f \$CURRENT ]; then
            cp \$CURRENT \$BACKUP
            echo 'Backup created:' \$BACKUP
          fi
        "

        # Copy new jar
        scp target/*.jar nerch@$SERVER:/opt/nerch/server.jar

        # Restart service
        ssh nerch@$SERVER "sudo systemctl restart nerch"

        # Check service status
        if ssh nerch@$SERVER "sudo systemctl is-active --quiet nerch"; then
          echo "Deployment successful on $SERVER"
        else
          echo "Deployment FAILED on $SERVER â€” rolling back"

          ssh nerch@$SERVER "
            CURRENT=/opt/nerch/server.jar
            BACKUP=/opt/nerch/server_${TIMESTAMP}.jar
            FAILED=/opt/nerch/server_failed_${TIMESTAMP}.jar

            mv \$CURRENT \$FAILED
            cp \$BACKUP \$CURRENT
            sudo systemctl restart nerch
          "

          echo "Rollback completed on $SERVER"
        fi
      done
#test:
#  script:
#    - echo "Runner is alive"
#

