stages:
  - build
  - deploy

# -------------------------
# BUILD STAGE (Docker runner)
# -------------------------
build:
  stage: build

  # your docker runner tag
  image: maven:3.9-eclipse-temurin-21

  script:
    - cd server
    - mvn clean package -DskipTests

  artifacts:
    paths:
      - server/target/*.jar
    expire_in: 1 day

# -------------------------
# DEPLOY STAGE (Shell runner)
# -------------------------
deploy:
  stage: deploy
  tags:
    - nerchRunner
  needs:
    - build

  script:
    - |
      set -e  # Exit on any error
      
      echo "===== RUNNER DETAILS ====="
      echo "Hostname: $(hostname)"
      echo "User: $(whoami)"
      echo "PWD: $(pwd)"
      echo "HOME: $HOME"
      echo "DEPLOY_SERVERS = [$DEPLOY_SERVERS]"

      if [ -z "$DEPLOY_SERVERS" ]; then
        echo "ERROR: DEPLOY_SERVERS is empty"
        exit 1
      fi

      # Use absolute path
      SSH_KEY="$HOME/.ssh/gitlab_key"
      
      if [ ! -f "$SSH_KEY" ]; then
        echo "ERROR: SSH key not found at $SSH_KEY"
        exit 1
      fi
      
      echo "SSH key: $SSH_KEY (permissions: $(stat -c '%a' $SSH_KEY))"
      
      TIMESTAMP=$(date +%d%m%Y_%H%M%S)
      JAR_FILE=$(ls server/target/*.jar | head -n 1)
      
      if [ -z "$JAR_FILE" ]; then
        echo "ERROR: No JAR file found"
        exit 1
      fi
      
      echo "JAR file: $JAR_FILE"

      SSH_CMD="ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
      SCP_CMD="scp -i $SSH_KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

      for SERVER in $DEPLOY_SERVERS; do
        echo ""
        echo "===== Deploying to nerch@$SERVER ====="
      
        # Test connection
        echo "→ Testing SSH connection..."
        if ! $SSH_CMD nerch@$SERVER "echo 'Connected as:' && whoami"; then
          echo "ERROR: SSH connection failed"
          exit 1
        fi
      
        # Test sudo
        echo "→ Testing sudo permissions..."
        if ! $SSH_CMD nerch@$SERVER "sudo -n systemctl is-active nerch"; then
          echo "ERROR: Sudo test failed"
          exit 1
        fi

        # Backup existing JAR
        echo "→ Creating backup..."
        $SSH_CMD nerch@$SERVER "
          BACKUP=/opt/nerch/server_${TIMESTAMP}.jar
          CURRENT=/opt/nerch/server.jar
          if [ -f \$CURRENT ]; then
            cp \$CURRENT \$BACKUP
            echo 'Backup created: \$BACKUP'
          else
            echo 'No existing JAR to backup'
          fi
        "

        # Copy new JAR
        echo "→ Copying new JAR..."
        $SCP_CMD "$JAR_FILE" nerch@$SERVER:/opt/nerch/server.jar

        # Restart service
        echo "→ Restarting service..."
        $SSH_CMD nerch@$SERVER "sudo -n systemctl restart nerch"
      
        echo "→ Waiting 10 seconds for service to start..."
        sleep 10

        # Check if service is running
        echo "→ Verifying service status..."
        if $SSH_CMD nerch@$SERVER "sudo -n systemctl is-active --quiet nerch"; then
          echo "✓ Deployment successful on $SERVER"
          $SSH_CMD nerch@$SERVER "sudo -n systemctl status nerch --no-pager -l"
        else
          echo "✗ Service failed to start — initiating rollback"
      
          $SSH_CMD nerch@$SERVER "
            echo 'Moving failed JAR...'
            mv /opt/nerch/server.jar /opt/nerch/server_failed_${TIMESTAMP}.jar
      
            echo 'Restoring backup...'
            cp /opt/nerch/server_${TIMESTAMP}.jar /opt/nerch/server.jar
      
            echo 'Restarting service...'
            sudo -n systemctl restart nerch
      
            echo 'Rollback complete. Service status:'
            sudo -n systemctl status nerch --no-pager
          "
          exit 1
        fi
      done
      
      echo ""
      echo "===== DEPLOYMENT COMPLETE ====="