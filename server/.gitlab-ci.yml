stages:
  - build
  - deploy

# -------------------------
# BUILD STAGE
# -------------------------
build:
  stage: build
  image: maven:3.9-eclipse-temurin-21
  script:
    - cd server
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - server/target/*.jar
    expire_in: 1 day

# -------------------------
# DEPLOY STAGE
# -------------------------
deploy:
  stage: deploy
  image: alpine:latest

  before_script:
    - apk add --no-cache openssh curl iproute2

    # SSH setup
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    # Write private key safely
    - printf "%s" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/gitlab_key
    - chmod 600 ~/.ssh/gitlab_key

    # Optional but convenient
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

  script:
    - |
      echo "===== RUNNER DETAILS ====="
      echo "Hostname: $(hostname)"
      echo "User: $(whoami)"
      echo "Public IP: $(curl -s ifconfig.me)"
      ip addr || true

      TIMESTAMP=$(date +%d%m%Y_%H%M%S)
#      SERVERS="$DEPLOY_SERVERS"

      for SERVER in $DEPLOY_SERVERS; do
        ssh-keyscan -H $SERVER >> ~/.ssh/known_hosts || true
      done

      for SERVER in $SERVERS; do
        echo "Deploying to $SERVER ..."

        ssh nerch@$SERVER "
          BACKUP=/opt/nerch/server_${TIMESTAMP}.jar
          CURRENT=/opt/nerch/server.jar

          if [ -f \$CURRENT ]; then
            cp \$CURRENT \$BACKUP
          fi
        "

        scp server/target/*.jar nerch@$SERVER:/opt/nerch/server.jar

        ssh nerch@$SERVER "sudo systemctl restart nerch"

        if ssh nerch@$SERVER "sudo systemctl is-active --quiet nerch"; then
          echo "Deployment successful"
        else
          echo "Deployment failed â€” rollback"

          ssh nerch@$SERVER "
            mv /opt/nerch/server.jar /opt/nerch/server_failed_${TIMESTAMP}.jar
            cp /opt/nerch/server_${TIMESTAMP}.jar /opt/nerch/server.jar
            sudo systemctl restart nerch
          "
        fi
      done
