stages:
  - build
  - deploy

# -------------------------
# BUILD STAGE
# -------------------------
build:
  stage: build
  script:
    - cd server
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - server/target/*.jar
    expire_in: 1 day

# -------------------------
# DEPLOY STAGE
# -------------------------
deploy:
  stage: deploy

  variables:
    DEPLOY_SERVERS: ""

  before_script:
    # Ensure SSH dir exists for runner user
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    # Optional: avoid host key prompts
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

    # Load key (only needed if key is not default name)
    # If your key is ~/.ssh/id_ed25519 you can REMOVE this line
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/id_ed25519

  script:
    - |
      echo "===== RUNNER DETAILS ====="
      echo "Hostname: $(hostname)"
      echo "User: $(whoami)"
      echo "Home: $HOME"
      echo "Public IP: $(curl -s ifconfig.me)"
      ip addr || true

      TIMESTAMP=$(date +%d%m%Y_%H%M%S)
      SERVERS="$DEPLOY_SERVERS"

      # Populate known_hosts (optional)
      for SERVER in $SERVERS; do
        ssh-keyscan -H $SERVER >> ~/.ssh/known_hosts || true
      done

      # Deployment loop
      for SERVER in $SERVERS; do
        echo "Deploying to $SERVER ..."

        ssh nerch@$SERVER "
          BACKUP=/opt/nerch/server_${TIMESTAMP}.jar
          CURRENT=/opt/nerch/server.jar

          if [ -f \$CURRENT ]; then
            cp \$CURRENT \$BACKUP
          fi
        "

        scp server/target/*.jar nerch@$SERVER:/opt/nerch/server.jar

        ssh nerch@$SERVER "sudo systemctl restart nerch"

        if ssh nerch@$SERVER "sudo systemctl is-active --quiet nerch"; then
          echo "Deployment successful"
        else
          echo "Deployment failed â€” rollback"

          ssh nerch@$SERVER "
            mv /opt/nerch/server.jar /opt/nerch/server_failed_${TIMESTAMP}.jar
            cp /opt/nerch/server_${TIMESTAMP}.jar /opt/nerch/server.jar
            sudo systemctl restart nerch
          "
        fi
      done
