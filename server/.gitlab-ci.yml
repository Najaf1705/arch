stages:
  - build
  - deploy

# -------------------------
# BUILD STAGE
# -------------------------
build:
  tags:
    - nerchRunner
  stage: build
  image: maven:3.9-eclipse-temurin-21
  script:
    - cd server
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - server/target/*.jar
    expire_in: 1 day

# -------------------------
# DEPLOY STAGE
# -------------------------
deploy:
  tags:
    - nerchRunner
  stage: deploy
  image: alpine:latest

  before_script:
    - apk add --no-cache openssh curl iproute2

    # SSH setup
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

    # Write private key
    - printf "%s" "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/gitlab_key
    - chmod 600 ~/.ssh/gitlab_key

  script:
    - |
      echo "===== RUNNER DETAILS ====="
      echo "Hostname: $(hostname)"
      echo "User: $(whoami)"
      echo "DEPLOY_SERVERS = [$DEPLOY_SERVERS]"

      if [ -z "$DEPLOY_SERVERS" ]; then
        echo "ERROR: DEPLOY_SERVERS is empty"
        exit 1
      fi

      TIMESTAMP=$(date +%d%m%Y_%H%M%S)

      echo "Artifacts available:"
      ls -lah server/target/

      for SERVER in $DEPLOY_SERVERS; do
        echo "Deploying to $SERVER ..."

        # Backup current jar
        ssh -i ~/.ssh/gitlab_key \
            -o StrictHostKeyChecking=no \
            nerch@$SERVER "
              BACKUP=/opt/nerch/server_${TIMESTAMP}.jar
              CURRENT=/opt/nerch/server.jar

              if [ -f \$CURRENT ]; then
                cp \$CURRENT \$BACKUP
              fi
            "

        # Copy new jar
        scp -i ~/.ssh/gitlab_key \
            -o StrictHostKeyChecking=no \
            server/target/*.jar \
            nerch@$SERVER:/opt/nerch/server.jar

        # Verify updated file
        ssh -i ~/.ssh/gitlab_key \
            -o StrictHostKeyChecking=no \
            nerch@$SERVER "ls -lh /opt/nerch/server.jar"

        # Restart service
        ssh -i ~/.ssh/gitlab_key \
            -o StrictHostKeyChecking=no \
            nerch@$SERVER "sudo systemctl restart nerch"

        # Health check + rollback
        if ssh -i ~/.ssh/gitlab_key \
              -o StrictHostKeyChecking=no \
              nerch@$SERVER "sudo systemctl is-active --quiet nerch"; then
          echo "Deployment successful on $SERVER"
        else
          echo "Deployment failed â€” rollback"

          ssh -i ~/.ssh/gitlab_key \
              -o StrictHostKeyChecking=no \
              nerch@$SERVER "
                mv /opt/nerch/server.jar /opt/nerch/server_failed_${TIMESTAMP}.jar
                cp /opt/nerch/server_${TIMESTAMP}.jar /opt/nerch/server.jar
                sudo systemctl restart nerch
              "
        fi
      done
