stages:
  - build
  - deploy

# -------------------------
# BUILD STAGE
# -------------------------
build:
  stage: build
  image: maven:3.9-eclipse-temurin-21
  script:
    - cd server
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - server/target/*.jar
    expire_in: 1 day

# -------------------------
# DEPLOY STAGE
# -------------------------
deploy:
  stage: deploy
  image: alpine:latest

  before_script:
    - apk add --no-cache openssh
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh

  variables:
    DEPLOY_SERVERS: ""

  script:
    - |
      TIMESTAMP=$(date +%d%m%Y_%H%M%S)

      SERVERS="$DEPLOY_SERVERS"

      # known_hosts
      for SERVER in $SERVERS; do
        ssh-keyscan -H $SERVER >> ~/.ssh/known_hosts
      done

      # deployment
      for SERVER in $SERVERS; do
        echo "Deploying to $SERVER ..."

        ssh nerch@$SERVER "
          BACKUP=/opt/nerch/server_${TIMESTAMP}.jar
          CURRENT=/opt/nerch/server.jar

          if [ -f \$CURRENT ]; then
            cp \$CURRENT \$BACKUP
          fi
        "

        scp server/target/*.jar nerch@$SERVER:/opt/nerch/server.jar
        ssh nerch@$SERVER "sudo systemctl restart nerch"

        if ssh nerch@$SERVER "sudo systemctl is-active --quiet nerch"; then
          echo "Deployment successful"
        else
          echo "Deployment failed â€” rollback"

          ssh nerch@$SERVER "
            mv /opt/nerch/server.jar /opt/nerch/server_failed_${TIMESTAMP}.jar
            cp /opt/nerch/server_${TIMESTAMP}.jar /opt/nerch/server.jar
            sudo systemctl restart nerch
          "
        fi
      done
