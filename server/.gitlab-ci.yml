stages:
  - build
  - deploy

# -------------------------
# BUILD STAGE (Docker runner)
# -------------------------
build:
  stage: build

  # your docker runner tag
  image: maven:3.9-eclipse-temurin-21

  script:
    - cd server
    - mvn clean package -DskipTests

  artifacts:
    paths:
      - server/target/*.jar
    expire_in: 1 day

# -------------------------
# DEPLOY STAGE (Shell runner)
# -------------------------
deploy:
  stage: deploy
  tags:
    - nerchRunner
  needs:
    - build

  script:
    - |
      set -e  # Exit on any error
      
      echo "===== RUNNER DETAILS ====="
      echo "Hostname: $(hostname)"
      echo "User: $(whoami)"
      echo "PWD: $(pwd)"
      echo "HOME: $HOME"
      echo "DEPLOY_SERVERS = [$DEPLOY_SERVERS]"

      if [ -z "$DEPLOY_SERVERS" ]; then
        echo "ERROR: DEPLOY_SERVERS is empty"
        exit 1
      fi

      # Use absolute path
      SSH_KEY="$HOME/.ssh/gitlab_key"
      
      if [ ! -f "$SSH_KEY" ]; then
        echo "ERROR: SSH key not found at $SSH_KEY"
        exit 1
      fi
      
      echo "SSH key: $SSH_KEY (permissions: $(stat -c '%a' $SSH_KEY))"
      
      TIMESTAMP=$(date +%d%m%Y_%H%M%S)
      JAR_FILE=$(ls server/target/*.jar | head -n 1)
      
      if [ -z "$JAR_FILE" ]; then
        echo "ERROR: No JAR file found"
        exit 1
      fi
      
      echo "JAR file: $JAR_FILE"

      SSH_CMD="ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
      SCP_CMD="scp -i $SSH_KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

      for SERVER in $DEPLOY_SERVERS; do
        echo ""
        echo "===== Deploying to nerch@$SERVER ====="
      
        # Test connection
        echo "→ Testing SSH connection..."
        if ! $SSH_CMD nerch@$SERVER "echo 'Connected as:' && whoami"; then
          echo "ERROR: SSH connection failed"
          exit 1
        fi
      
        # Test sudo
        echo "→ Testing sudo permissions..."
        if ! $SSH_CMD nerch@$SERVER "sudo -n systemctl is-active nerch"; then
          echo "ERROR: Sudo test failed"
          exit 1
        fi

        # Backup existing JAR
        echo "→ Creati