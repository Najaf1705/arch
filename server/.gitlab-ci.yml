stages:
  - build
  - deploy

# -------------------------
# BUILD STAGE (Docker runner)
# -------------------------
build:
  stage: build

  # your docker runner tag
  image: maven:3.9-eclipse-temurin-21

  script:
    - cd server
    - mvn clean package -DskipTests

  artifacts:
    paths:
      - server/target/*.jar
    expire_in: 1 day

# -------------------------
# DEPLOY STAGE (Shell runner)
# -------------------------
deploy:
  stage: deploy
  tags:
    - nerchRunner
  needs:
    - build

  script:
    - |
      echo "===== RUNNER DETAILS ====="
      echo "Hostname: $(hostname)"
      echo "User: $(whoami)"
      echo "DEPLOY_SERVERS = [$DEPLOY_SERVERS]"

      if [ -z "$DEPLOY_SERVERS" ]; then
        echo "ERROR: DEPLOY_SERVERS is empty"
        exit 1
      fi

      SSH_KEY="/home/gitlab-runner/.ssh/gitlab_key"
      TIMESTAMP=$(date +%d%m%Y_%H%M%S)
      JAR_FILE=$(ls server/target/*.jar | head -n 1)

      SSH_CMD="ssh -i $SSH_KEY -o StrictHostKeyChecking=no"
      SCP_CMD="scp -i $SSH_KEY -o StrictHostKeyChecking=no"

      for SERVER in $DEPLOY_SERVERS; do
        echo "Deploying to nerch@$SERVER ..."

        $SSH_CMD nerch@$SERVER "
          BACKUP=/opt/nerch/server_${TIMESTAMP}.jar
          CURRENT=/opt/nerch/server.jar

          if [ -f \$CURRENT ]; then
            cp \$CURRENT \$BACKUP
          fi
        "

        $SCP_CMD "$JAR_FILE" nerch@$SERVER:/opt/nerch/server.jar

        $SSH_CMD nerch@$SERVER "sudo systemctl restart nerch"

        if $SSH_CMD nerch@$SERVER "sudo systemctl is-active --quiet nerch"; then
          echo "Deployment successful on $SERVER"
        else
          echo "Deployment failed â€” rollback"

          $SSH_CMD nerch@$SERVER "
            mv /opt/nerch/server.jar /opt/nerch/server_failed_${TIMESTAMP}.jar
            cp /opt/nerch/server_${TIMESTAMP}.jar /opt/nerch/server.jar
            sudo systemctl restart nerch
          "
        fi
      done
