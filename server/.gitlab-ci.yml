stages:
  - build
  - deploy
  - rollback

# -------------------------
# BUILD STAGE
# -------------------------
build:
  stage: build
  image: maven:3.9-eclipse-temurin-21

  script:
    - cd server
    - mvn clean package -DskipTests

  artifacts:
    paths:
      - server/target/*.jar
    expire_in: 1 day


# -------------------------
# DEPLOY STAGE
# -------------------------
deploy:
  stage: deploy
  tags:
    - nerchRunner
  needs:
    - build
#  only:
#    - main

  script:
    - |
      set -e
  
      SSH_KEY="$HOME/.ssh/gitlab_key"
      SSH_CMD="ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
      SCP_CMD="scp -i $SSH_KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
  
      TIMESTAMP=$(date +%d%m%Y_%H%M%S)
      JAR_FILE=$(ls server/target/*.jar | head -n 1)
  
      if [ -z "$JAR_FILE" ]; then
        echo "No JAR found"
        exit 1
      fi
  
      for SERVER in $DEPLOY_SERVERS; do
        echo "===== Deploying to nerch@$SERVER ====="
  
        $SSH_CMD nerch@$SERVER "mkdir -p /opt/nerch/backups"
  
        $SSH_CMD nerch@$SERVER "
          if [ -f /opt/nerch/server.jar ]; then
            cp /opt/nerch/server.jar /opt/nerch/backups/server_${TIMESTAMP}.jar
          fi
          if [ -f /opt/nerch/.env ]; then
            cp /opt/nerch/.env /opt/nerch/backups/env_${TIMESTAMP}
          fi
          echo ${TIMESTAMP} > /opt/nerch/backups/LATEST
        "
  
        $SCP_CMD "$JAR_FILE" nerch@$SERVER:/opt/nerch/server.jar
  
        $SSH_CMD nerch@$SERVER "printf 'SPRING_PROFILES_ACTIVE=prod\nMONGO_URI=${MONGO_URI}\nMAIL_USERNAME=${MAIL_USERNAME}\nMAIL_PASSWORD=${MAIL_PASSWORD}\nJWT_SECRET=${JWT_SECRET}\nCORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}\n' > /opt/nerch/.env && chmod 600 /opt/nerch/.env"
  
        $SSH_CMD nerch@$SERVER "sudo -n systemctl restart nerch"
  
        echo "✓ Deployment complete on $SERVER"
      done
  
      echo "===== DEPLOY FINISHED ====="

# -------------------------
# MANUAL ROLLBACK
# -------------------------
rollback:
  stage: rollback
  tags:
    - nerchRunner
  when: manual
#  only:
#    - main

  script:
    - |
      set -e

      SSH_KEY="$HOME/.ssh/gitlab_key"
      SSH_CMD="ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

      for SERVER in $DEPLOY_SERVERS; do
        echo "===== Rolling back on nerch@$SERVER ====="

        $SSH_CMD nerch@$SERVER "
          if [ ! -f /opt/nerch/backups/LATEST ]; then
            echo 'No backup available'
            exit 1
          fi

          TS=\$(cat /opt/nerch/backups/LATEST)

          if [ -f /opt/nerch/backups/server_\$TS.jar ]; then
            cp /opt/nerch/backups/server_\$TS.jar /opt/nerch/server.jar
          fi

          if [ -f /opt/nerch/backups/env_\$TS ]; then
            cp /opt/nerch/backups/env_\$TS /opt/nerch/.env
          fi

          sudo -n systemctl restart nerch
        "

        echo "✓ Rollback complete on $SERVER"
      done

      echo "===== ROLLBACK FINISHED ====="